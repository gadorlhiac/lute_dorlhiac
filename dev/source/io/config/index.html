<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="GFD, VM" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>config - LUTE</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "config";
        var mkdocs_page_input_path = "source/io/config.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> LUTE
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../usage/">Quick Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Walkthroughs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../tutorial/new_task/">Creating a new Task</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../tutorial/creating_workflows/">Creating a new Workflow</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Source Code</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../managed_tasks/">managed_tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">execution</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../execution/executor/">executor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../execution/ipc/">ipc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../execution/debug_utils/">debug_utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">tasks</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../tasks/task/">task</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tasks/dataclasses/">dataclasses</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tasks/sfx_find_peaks/">sfx_find_peaks</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tasks/sfx_index/">sfx_index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tasks/test/">test</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">io</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="#">models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../models/base/">base</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/sfx_find_peaks/">sfx_find_peaks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/sfx_index/">sfx_index</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/sfx_merge/">sfx_merge</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/sfx_solve/">sfx_solve</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/smd/">smd</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../models/tests/">tests</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">config</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../db/">db</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../_sqlite/">_sqlite</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../elog/">elog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../exceptions/">exceptions</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Design and Specifications</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../design/database/">Database</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">LUTE</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Source Code &raquo;</li>
          <li>io &raquo;</li>
      <li>config</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/slac-lcls/lute/edit/master/docs/source/io/config.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="io.config"></a>
    <div class="doc doc-contents first">

      <p>Machinary for the IO of configuration YAML files and their validation.</p>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="io.config.parse_config" href="#io.config.parse_config">parse_config</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>str, config_path: str) -&gt; TaskParameters: Parse a
configuration file and return a TaskParameters object of validated
parameters for a specific Task. Raises an exception if the provided
configuration does not match the expected model.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>ValidationError</code>
              –
              <div class="doc-md-description">
                <p>Error raised by pydantic during data validation. (From
Pydantic)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="io.config.parse_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_config</span><span class="p">(</span><span class="n">task_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Parse a configuration file and validate the contents.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>task_name</code></b>
                  (<code>str</code>, default:
                      <code>&#39;test&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Name of the specific task that will be run.</p>
              </div>
            </li>
            <li>
              <b><code>config_path</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Path to the configuration file.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>params</code></b>(                  <code><a class="autorefs autorefs-internal" title="io.models.TaskParameters" href="../models/base/#io.models.base.TaskParameters">TaskParameters</a></code>
)              –
              <div class="doc-md-description">
                <p>A TaskParameters object of validated
task-specific parameters. Parameters are accessed with "dot"
notation. E.g. <code>params.param1</code>.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>ValidationError</code>
              –
              <div class="doc-md-description">
                <p>Raised if there are problems with the configuration
file. Passed through from Pydantic.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>lute/io/config.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_config</span><span class="p">(</span><span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a configuration file and validate the contents.</span>

<span class="sd">    Args:</span>
<span class="sd">        task_name (str): Name of the specific task that will be run.</span>

<span class="sd">        config_path (str): Path to the configuration file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        params (TaskParameters): A TaskParameters object of validated</span>
<span class="sd">            task-specific parameters. Parameters are accessed with &quot;dot&quot;</span>
<span class="sd">            notation. E.g. `params.param1`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValidationError: Raised if there are problems with the configuration</span>
<span class="sd">            file. Passed through from Pydantic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_config_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">Parameters&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">docs</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="n">header</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="n">substitute_variables</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
    <span class="n">substitute_variables</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">LUTE_DEBUG_EXIT</span><span class="p">(</span><span class="s2">&quot;LUTE_DEBUG_EXIT_AT_YAML&quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
    <span class="n">lute_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AnalysisHeader</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lute_config&quot;</span><span class="p">:</span> <span class="n">AnalysisHeader</span><span class="p">(</span><span class="o">**</span><span class="n">header</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">task_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">task_name</span><span class="p">])</span>
        <span class="n">lute_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_config</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2"> has no parameter definitions in YAML file.&quot;</span>
                <span class="s2">&quot; Attempting default parameter initialization.&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">parsed_parameters</span><span class="p">:</span> <span class="n">TaskParameters</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">task_config_name</span><span class="p">](</span><span class="o">**</span><span class="n">lute_config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_parameters</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="io.config.substitute_variables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">substitute_variables</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">curr_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Performs variable substitutions on a dictionary read from config YAML file.</p>
<p>Can be used to define input parameters in terms of other input parameters.
This is similar to functionality employed by validators for parameters in
the specific Task models, but is intended to be more accessible to users.
Variable substitutions are defined using a minimal syntax from Jinja:
                           {{ experiment }}
defines a substitution of the variable <code>experiment</code>. The characters <code>{{ }}</code>
can be escaped if the literal symbols are needed in place.</p>
<p>For example, a path to a file can be defined in terms of experiment and run
values in the config file:
    MyTask:
      experiment: myexp
      run: 2
      special_file: /path/to/{{ experiment }}/{{ run }}/file.inp</p>
<p>Acceptable variables for substitutions are values defined elsewhere in the
YAML file. Environment variables can also be used if prefaced with a <code>$</code>
character. E.g. to get the experiment from an environment variable:
    MyTask:
      run: 2
      special_file: /path/to/{{ $EXPERIMENT }}/{{ run }}/file.inp</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>config</code></b>
                  (<code><span title="io.models.Dict">Dict</span>[str, <span title="io.models.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
                <p>A dictionary of parsed configuration.</p>
              </div>
            </li>
            <li>
              <b><code>curr_key</code></b>
                  (<code><span title="io.models.Optional">Optional</span>[str]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Used to keep track of recursion level when scanning
through iterable items in the config dictionary.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>subbed_config</code></b>(                  <code><span title="io.models.Dict">Dict</span>[str, <span title="io.models.Any">Any</span>]</code>
)              –
              <div class="doc-md-description">
                <p>The config dictionary after substitutions
have been made. May be identical to the input if no substitutions are
needed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>lute/io/config.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">substitute_variables</span><span class="p">(</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">curr_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs variable substitutions on a dictionary read from config YAML file.</span>

<span class="sd">    Can be used to define input parameters in terms of other input parameters.</span>
<span class="sd">    This is similar to functionality employed by validators for parameters in</span>
<span class="sd">    the specific Task models, but is intended to be more accessible to users.</span>
<span class="sd">    Variable substitutions are defined using a minimal syntax from Jinja:</span>
<span class="sd">                               {{ experiment }}</span>
<span class="sd">    defines a substitution of the variable `experiment`. The characters `{{ }}`</span>
<span class="sd">    can be escaped if the literal symbols are needed in place.</span>

<span class="sd">    For example, a path to a file can be defined in terms of experiment and run</span>
<span class="sd">    values in the config file:</span>
<span class="sd">        MyTask:</span>
<span class="sd">          experiment: myexp</span>
<span class="sd">          run: 2</span>
<span class="sd">          special_file: /path/to/{{ experiment }}/{{ run }}/file.inp</span>

<span class="sd">    Acceptable variables for substitutions are values defined elsewhere in the</span>
<span class="sd">    YAML file. Environment variables can also be used if prefaced with a `$`</span>
<span class="sd">    character. E.g. to get the experiment from an environment variable:</span>
<span class="sd">        MyTask:</span>
<span class="sd">          run: 2</span>
<span class="sd">          special_file: /path/to/{{ $EXPERIMENT }}/{{ run }}/file.inp</span>

<span class="sd">    Args:</span>
<span class="sd">        config (Dict[str, Any]):  A dictionary of parsed configuration.</span>

<span class="sd">        curr_key (Optional[str]): Used to keep track of recursion level when scanning</span>
<span class="sd">            through iterable items in the config dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        subbed_config (Dict[str, Any]): The config dictionary after substitutions</span>
<span class="sd">            have been made. May be identical to the input if no substitutions are</span>
<span class="sd">            needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_sub_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\{\{[^}{]*\}\}&quot;</span>
    <span class="n">iterable</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">if</span> <span class="n">curr_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Need to handle nested levels by interpreting curr_key</span>
        <span class="n">keys_by_level</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_by_level</span><span class="p">:</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="c1"># iterable = config</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_key</span><span class="p">:</span> <span class="nb">str</span>
            <span class="k">if</span> <span class="n">curr_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">param</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">curr_key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">substitute_variables</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">curr_key</span><span class="o">=</span><span class="n">new_key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="c1"># Scalars str - we skip numeric types</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">_sub_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">key_to_sub_maybe_with_fmt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">key_to_sub</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">key_to_sub_maybe_with_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fmt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_to_sub_maybe_with_fmt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="n">key_to_sub_maybe_with_fmt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sub</span><span class="p">:</span> <span class="n">Any</span>
                <span class="k">if</span> <span class="n">key_to_sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">key_to_sub</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Environment variable </span><span class="si">{</span><span class="n">key_to_sub</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2"> not found! Cannot substitute in YAML config!&quot;</span><span class="p">,</span>
                            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># substitutions from env vars will be strings, so convert back</span>
                    <span class="c1"># to numeric in order to perform formatting later on (e.g. {var:04d})</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="n">_check_str_numeric</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">config</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_to_sub</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                            <span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key_to_sub</span><span class="p">]</span>
                <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\{\{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}}&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\}\}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\$&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">:{</span><span class="n">fmt</span><span class="si">}}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">iterable</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">iterable</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
            <span class="c1"># Reconvert back to numeric values if needed...</span>
            <span class="n">iterable</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">_check_str_numeric</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../models/tests/" class="btn btn-neutral float-left" title="tests"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../db/" class="btn btn-neutral float-right" title="db">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>© 2024 LCLS</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/slac-lcls/lute" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../models/tests/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../db/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
      <script src="../../../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
